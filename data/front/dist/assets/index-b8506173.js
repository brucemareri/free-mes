import{d as e,e as t,f as a,g as l,a6 as n,C as s,o,c as i,J as d,k as r,w as u,j as p,X as f,G as g,a as c,F as y,n as v,t as m,z as x,I as b,cB as _,H as h,aa as w,aC as k,Z as z,ac as C,ad as N,ab as V,v as M,cn as S,co as j,E as D,ae as I,A as $,B as q,a0 as H,cx as U,bN as T,x as E,y as P,_ as A}from"./index-4bfb878d.js";import"./index-529a6cde.js";import{c as B}from"./index-6c8a85ac.js";import{c as F,e as O,f as R}from"./workStationSelect-30f7fdab.js";import{m as Q,i as L,n as Y,j as G,o as J}from"./pmOrder-563fbf59.js";import{S as X}from"./const-f443e30b.js";import{u as Z,p as K}from"./proTask-47af4050.js";import{t as W}from"./data-636d1bc2.js";import ee from"./printContent-4bae174b.js";import{d as te}from"./dhtmlxgantt-859de0ac.js";import"./shiftSet-d38e6bbc.js";import"./schedulingPlan-bc6ff850.js";const ae=e=>(E("data-v-ad8ea58c"),e=e(),P(),e),le={class:"flex",style:{"margin-bottom":"20px","justify-content":"space-between"}},ne={style:{width:"350px"}},se={class:"flex"},oe=ae((()=>p("div",{style:{width:"300px","line-height":"30px","font-size":"15px"}},"订单/任务编号",-1))),ie={class:"dialog-footer"},de={id:"printMe",style:{height:"400px"}},re=ae((()=>p("div",null,[p("span"),p("span",null," 当前排产详情任务详情 ")],-1))),ue=A(e({__name:"index",setup(e){const E=t(),P=Z(),A=[{label:"Y",text:"逐个工序"},{label:"N",text:"工单数量"}],ae=t("Y"),ue=t(!1),pe=a({workorderCode:"",workorderName:"",productCode:"",productName:"",clientName:"",requestDate:""});let fe=a({total:0,pageSize:5,pageSizes:[5,10,15,20],currentPage:1}),ge=a({total:0,pageSize:5,pageSizes:[5,10,15,20],currentPage:1});t([]);const ce=t(),ye=t([]),ve=a({id:"printMe"}),me=t(!1),xe=t(!1);a([]);let be=t(""),_e=t({workorderCode:"",autoGenFlag:!1,workorderName:"",orderSource:"STORE",sourceCode:"",productCode:"",productName:"",productSpc:"",unitOfMeasure:"",quantity:1,requestDate:"",batchCode:"",clientCode:"",clientName:"",remark:"",id:null,parentId:null}),he=t([]),we=t(!1),ke=t("");const ze=t(!1),Ce=t([]),Ne=t(),Ve=t(),Me=()=>{Q({workorderId:_e.value.id}).then((e=>{Pe(),Ae(),Ge()}))},Se=e=>{$e(e),Ae(),Ge()};let je=t("");const De=()=>{ze.value=!1,je.value=""},Ie=e=>{$e(e)},$e=async e=>{const t={workorderCode:_e.value.workorderCode,processId:e};try{const e=await F(t);P.orderCount=e.residueQuantity,Ve.value=e.residueQuantity}catch(a){console.error(a)}},qe=async()=>{try{const e=await O(_e.value.productId);return he.value=e,ke.value=he.value[0].processId,e}catch(e){return console.error(e),[]}},He=t(),Ue=t([]),Te=t([]),Ee=e=>{ge=null==e?void 0:e.value,new Promise(((e,t)=>{Ne.value=!0;const a={pageNo:ge.currentPage,workOrderCode:je.value,pageSize:ge.pageSize};R(a).then((t=>{const{list:a,total:l}=t||{};Ce.value=a,ge.total=l,e(t)})).finally((()=>{Ne.value=!1}))}))},Pe=()=>{E.value&&(E.value.resetFields(),xe.value=!1,we.value=!1)},Ae=()=>{const e={...pe,pageNo:fe.currentPage,pageSize:fe.pageSize};me.value=!0,G(e).then((e=>{const{total:t,list:a=[]}=e||{};fe.total=t})).finally((()=>{me.value=!1}))},Be=t(),Fe=t(),Oe=t(),Re=()=>{te.gantt.refreshData()},Qe=(e,t)=>(t=t||!1,te.gantt.eachTask((function(e){Qe(e)&&(t=!0)}),e.id),e.code.toLowerCase().indexOf(Oe.value.toLowerCase())>-1&&(t=!0),t);te.gantt.attachEvent("onBeforeTaskDisplay",((e,t)=>!Oe.value||Qe(t)));const Le=()=>{te.gantt.config.show_grid?te.gantt.config.show_grid=!1:te.gantt.config.show_grid=!0,te.gantt.init(Fe.value)},Ye=()=>{te.gantt.ext.fullscreen.toggle()};te.gantt.attachEvent("onTaskClick",(function(e,t){var a=te.gantt.getTask(e),l=t.target.closest("[data-action]");if(l){switch(l.getAttribute("data-action")){case"view":(e=>{He.value=e.type;const t={id:e.id,type:e.type};Y(t).then((e=>{"project"==He.value?Ue.value=[{label:"订单编号",value:e.workorderCode},{label:"订单名称",value:e.workorderName},{label:"来源类型",value:X[e.orderSource]},{label:"产品编号",value:e.productCode},{label:"产品名称",value:e.productName},{label:"规格型号",value:e.productSpc},{label:"产品单位",value:e.unitOfMeasure},{label:"订单数量",value:e.quantity},{label:"需求日期",value:e.requestDate},{label:"客户编码",value:e.clientCode},{label:"客户名称",value:e.clientName},{label:"备注",value:e.remark}]:Te.value=[{label:"任务编号",value:e.taskCode},{label:"任务名称",value:e.taskName},{label:"数量",value:e.quantity},{label:"订单编号",value:e.workorderCode},{label:"订单名称",value:e.workorderName},{label:"工作站名称",value:e.workstationName},{label:"工序编号",value:e.processCode},{label:"工序名称",value:e.processName},{label:"开始生产时间",value:e.startTime},{label:"预计完成时间",value:e.requestDate}],ue.value=!0}))})(a);break;case"add":(async(e,t)=>{try{be.value=t;const a=await L(e);_e.value=a,P.orderCount=_e.value.quantity;const l=await qe();l.length>0&&($e(l[0].processId),xe.value=!0)}catch(a){console.error(a)}})(0!=a.parent?a.parent:a.id,"新增排产任务信息")}return!1}return!0}));const Ge=()=>{Ae(),new Promise(((e,t)=>{J().then((t=>{Be.value=t,e(t)}))})).then((e=>{const t=null==e?void 0:e.data.map((e=>({...e,start_date:_(e.start_date,"yyyy-MM-dd"),end_date:_(e.end_date,"yyyy-MM-dd"),progress:Number(e.progress)/100}))),a=null==e?void 0:e.links.map((e=>({...e,type:"1"})));var l,n;te.gantt.clearAll(),te.gantt.config.xml_date="%Y-%m-%d %H:%i:%s",te.gantt.i18n.setLocale("cn"),te.gantt.config.readonly=!1,te.gantt.config.show_links=!1,te.gantt.config.duration_unit="hour",te.gantt.config.duration_step=8,te.gantt.config.grid_width=650,te.gantt.config.columns=[{name:"code",label:"订单/任务编号",tree:!0,width:"550"},{name:"itemName",label:"产品名称",tree:!0,width:"400"},{name:"workstation",label:"工单执行",align:"center",width:"400"},{name:"quantity",label:"数量",align:"center",width:"400"},{name:"start_date",label:"开始时间",align:"center",width:"400"},{name:"end_date",label:"结束时间",align:"center",width:"400"},{name:"operate",label:"操作",template:function(e){return'<i style="margin-right: 12px;"  class="fa fa-file-text-o" data-action="view"></i><i class="fa fa-plus" data-action="add"></i>'},align:"center",min_width:150}],te.gantt.config.open_tree_initially=!0,te.gantt.templates.task_text=(e,t,a)=>"project"==a.type?"<b style='text-align:left;'>生产工单:</b> "+a.itemName+"    <span style='text-align:left;'> 完成比例："+100*a.progress+"% </span>":"<b style='text-align:left;'>生产任务:</b> "+a.process+" 数量"+a.quantity+"    <span style='text-align:left;'> 完成比例："+100*a.progress+"% </span>",te.gantt.config.show_task_cells=!0,te.gantt.config.scales=[{unit:"week",step:1,format:e=>{var t=te.gantt.date.date_to_str("%M %d"),a=te.gantt.date.add(te.gantt.date.add(e,1,"week"),-1,"day");return t(e)+" - "+t(a)}},{unit:"day",step:1,format:e=>{var t=te.gantt.date.date_to_str("%M %d"),a=te.gantt.date.date_to_str("%D");return t(e)+"("+a(e)+")"},css:e=>0===e.getDay()||6===e.getDay()?"weekend":""},{unit:"hour",step:8,format:"%H:%i"}],te.gantt.config.auto_types=!1,te.gantt.config.drag_progress=!1,te.gantt.config.drag_move=!0,te.gantt.config.drag_links=!1,te.gantt.config.drag_resize=!0,te.gantt.config.details_on_create=!0,te.gantt.config.details_on_dblclick=!0,te.gantt.config.fit_tasks=!0,te.gantt.config.scrollable=!0,te.gantt.config.links=!0,te.gantt.config.sort=!0,te.gantt.config.row_height=40,te.gantt.config.scale_height=70,te.gantt.config.lightbox=!1,te.gantt.plugins({fullscreen:!0,undo:!0,tooltip:!0,marker:!0,auto_scheduling:!0,critical_path:!0,quick_info:!1}),te.gantt.ext.fullscreen.getFullscreenElement=function(){return document.getElementById("myCover")},te.gantt.templates.tooltip_text=(e,t,a)=>"project"==a.type?` <div style="display: flex; flex-wrap: wrap;">\n    <div style="flex-basis: 50%;text-align: left;width: 50%;">\n      <span style="font-weight: bold; font-size: 17px">订单号：</span>\n      <span style="font-size: 16px">${a.code}</span>\n    </div>\n    <div style="flex-basis: 50%;text-align: right">\n      <span style="font-weight: bold; font-size: 17px">订单数量：</span>\n      <span style="font-size: 16px">${a.quantity}</span>\n    </div>\n    <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">已排产数量：</span>\n      <span style="font-size: 16px">${a.arrangedQuantity}</span>\n    </div>\n    <div style="flex-basis: 50%;text-align: right">\n      <span style="font-weight: bold; font-size: 17px">未排产数量：</span>\n      <span style="font-size: 16px">${a.unArrangedQuantity}</span>\n    </div>\n    <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">产品名称：</span>\n      <span style="font-size: 16px">${a.itemName}</span>\n    </div>\n    <div style="flex-basis: 50%;text-align: right">\n      <span style="font-weight: bold; font-size: 17px">产品编码：</span>\n      <span style="font-size: 16px">${a.itemCode}</span>\n    </div>\n    <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">预计开始时间：</span>\n      <span style="font-size: 16px">${_(a.start_date,"yyyy-MM-dd HH:mm:ss")}</span>\n    </div>\n    <div style="flex-basis: 50%;text-align: right">\n      <span style="font-weight: bold; font-size: 17px">预计结束时间：</span>\n      <span style="font-size: 16px">${_(a.end_date,"yyyy-MM-dd HH:mm:ss")}</span>\n    </div>\n    <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">订单接受日期：</span>\n      <span style="font-size: 16px">${_(a.orderDate,"yyyy-MM-dd HH:mm:ss")}</span>\n    </div>\n\n  </div>`:`<div style="display: flex; flex-wrap: wrap;">\n   <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">任务编号：</span>\n      <span style="font-size: 16px">${a.code}</span>\n    </div>\n   <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">产品名称：</span>\n      <span style="font-size: 16px">${a.itemName}</span>\n    </div>\n    <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">数量：</span>\n      <span style="font-size: 16px">${a.quantity}</span>\n    </div>\n   <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">工序名称：</span>\n <span style="font-size: 16px">${a.process}</span>\n    </div>\n   <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">开始生产时间：</span>\n   <span style="font-size: 16px">${_(a.start_date,"yyyy-MM-dd HH:mm:ss")}</span>\n    </div>\n   <div style="flex-basis: 50%;text-align: left">\n      <span style="font-weight: bold; font-size: 17px">预计完成时间：</span>\n      <span style="font-size: 16px">${_(a.end_date,"yyyy-MM-dd HH:mm:ss")}</span>\n    </div>\n  </div>`,te.gantt.attachEvent("onAfterTaskUpdate",(function(e,t){})),l=te.gantt.date.date_to_str(te.gantt.config.task_date),n=new Date,te.gantt.addMarker({start_date:n,css:"today",text:"今天",title:"今11天: "+l(n)}),te.gantt.init(Fe.value),te.gantt.parse({data:t,links:a}),te.gantt.render()}))};return l((()=>{Ge()})),(e,t)=>{const a=h,l=w,_=n("DArrowRight"),P=k,F=z,O=n("FullScreen"),R=C,Q=N,L=V,Y=M,G=S,J=j,X=D,Z=I,te=$,pe=q,fe=H,me=U,je=T,$e=s("print");return o(),i(y,null,[d("",!0),r(a,null,{default:u((()=>[p("div",le,[p("div",ne,[p("div",se,[oe,r(l,{modelValue:Oe.value,"onUpdate:modelValue":t[0]||(t[0]=e=>Oe.value=e),placeholder:"输入订单/任务编号",onInput:Re},null,8,["modelValue"]),r(F,{link:"",onClick:Le,type:"primary"},{default:u((()=>[r(P,{style:{"margin-right":"5px"},class:"el-icon--left"},{default:u((()=>[r(_)])),_:1}),f(" 隐藏左侧表格")])),_:1})])]),p("div",null,[r(F,{onClick:Ye,type:"primary"},{default:u((()=>[r(P,null,{default:u((()=>[r(O)])),_:1}),f(" 全屏")])),_:1})])]),p("div",{id:"myCover",ref_key:"ganttRef",ref:Fe,style:{"min-height":"500px"}},null,512)])),_:1}),d("",!0),(o(),g(fe,{key:Math.random(),width:"70%",modelValue:xe.value,"onUpdate:modelValue":t[3]||(t[3]=e=>xe.value=e),title:c(be),onBeforeClose:Pe},{footer:u((()=>[p("span",ie,["N"==ae.value?(o(),g(F,{key:0,type:"primary",onClick:Me},{default:u((()=>[f("确定排产 ")])),_:1})):d("",!0),r(F,{onClick:Pe},{default:u((()=>[f("返回")])),_:1})])])),default:u((()=>[r(Z,{ref_key:"ruleFormRef",ref:E,model:c(_e),"label-width":"70px"},{default:u((()=>[r(X,null,{default:u((()=>[r(Y,null,{default:u((()=>[r(L,{label:"排产类型",prop:"schedulingType"},{default:u((()=>[r(Q,{modelValue:ae.value,"onUpdate:modelValue":t[1]||(t[1]=e=>ae.value=e),class:"ml-4"},{default:u((()=>[(o(),i(y,null,v(A,((e,t)=>r(R,{label:e.label,key:t},{default:u((()=>[f(m(e.text),1)])),_:2},1032,["label"]))),64))])),_:1},8,["modelValue"])])),_:1})])),_:1}),"N"==ae.value?(o(),g(Y,{key:0},{default:u((()=>[r(J,null,{default:u((()=>[r(G,{label:"数量："},{default:u((()=>[f(m(c(_e).quantity),1)])),_:1})])),_:1})])),_:1})):d("",!0)])),_:1})])),_:1},8,["model"]),c(he).length&&"N"!=ae.value?(o(),g(pe,{key:0,modelValue:c(ke),"onUpdate:modelValue":t[2]||(t[2]=e=>x(ke)?ke.value=e:ke=e),class:"demo-tabs",onTabChange:Ie},{default:u((()=>[(o(!0),i(y,null,v(c(he),(e=>(o(),g(te,{label:e.processName,name:e.processId,key:e.processId},{default:u((()=>[r(K,{"tabs-id":c(ke),orderNum:Ve.value,onUpdateSchedulingTable:Se,"is-view":c(we),processId:e.processId,"work-order-id":c(_e).id},null,8,["tabs-id","orderNum","is-view","processId","work-order-id"])])),_:2},1032,["label","name"])))),128))])),_:1},8,["modelValue"])):d("",!0)])),_:1},8,["modelValue","title"])),r(fe,{modelValue:ze.value,"onUpdate:modelValue":t[4]||(t[4]=e=>ze.value=e),title:"排产任务数据",width:"70%",onBeforeClose:De},{default:u((()=>[r(B,{loading:Ne.value,columns:c(W),tableData:Ce.value,pagination:c(ge),onPaginationChange:Ee},{colorCode:u((({scope:e})=>[r(me,{modelValue:e.row.colorCode,"onUpdate:modelValue":t=>e.row.colorCode=t,disabled:""},null,8,["modelValue","onUpdate:modelValue"])])),_:1},8,["loading","columns","tableData","pagination"])])),_:1},8,["modelValue"]),r(fe,{modelValue:ce.value,"onUpdate:modelValue":t[6]||(t[6]=e=>ce.value=e),width:"70%",title:"打印生产任务单"},{footer:u((()=>[r(je),r(F,{onClick:t[5]||(t[5]=e=>ce.value=!1)},{default:u((()=>[f("关闭")])),_:1})])),default:u((()=>[b((o(),g(F,{type:"primary",icon:"printer"},{default:u((()=>[f("打印")])),_:1})),[[$e,ve]]),r(je),p("div",de,[r(ee,{"print-data-info":ye.value},null,8,["print-data-info"])])])),_:1},8,["modelValue"]),r(fe,{modelValue:ue.value,"onUpdate:modelValue":t[8]||(t[8]=e=>ue.value=e),title:"任务详情",width:"75%"},{footer:u((()=>[r(F,{onClick:t[7]||(t[7]=e=>ue.value=!1)},{default:u((()=>[f("返回")])),_:1})])),default:u((()=>[r(X,{class:"title",style:{"margin-top":"0"}},{default:u((()=>[re])),_:1}),"project"==He.value?(o(),g(J,{key:0,size:"large",column:4},{default:u((()=>[(o(!0),i(y,null,v(Ue.value,((e,t)=>(o(),g(G,{label:e.label,width:400,key:t},{default:u((()=>[f(m(e.value),1)])),_:2},1032,["label"])))),128))])),_:1})):(o(),g(J,{key:1,size:"large",column:4},{default:u((()=>[(o(!0),i(y,null,v(Te.value,((e,t)=>(o(),g(G,{label:e.label,width:400,key:t},{default:u((()=>[f(m(e.value),1)])),_:2},1032,["label"])))),128))])),_:1}))])),_:1},8,["modelValue"])],64)}}}),[["__scopeId","data-v-ad8ea58c"],["__file","/Users/alex/Downloads/万界星空/产品研发/MES框架/dev/xiejinrun/new_open_mes_front/src/views/prodMgmt/productionScheduling/index.vue"]]);export{ue as default};
