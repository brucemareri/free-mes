import{q as e,f as a,D as l,d as t,K as s,e as o,u as i,aS as n,g as d,C as r,o as u,c,j as m,k as p,w as f,a as y,z as v,t as h,I as w,G as k,J as _,F as g,n as b,X as x,aH as I,ce as V,aM as C,aN as S,M as U,aa as E,ch as T,a9 as j,l as A,L,aO as B,N as D,av as M,at as N,au as R,aJ as F,aq as P,a1 as z,a0 as O,ab as X,cM as q,ae as J,Y as K,aQ as Q,bF as W,x as Y,y as G,_ as H}from"./index-4bfb878d.js";import{a as $,b as Z,E as ee}from"./el-dropdown-item-4cc42342.js";import{d as ae,h as le}from"./tree-5260b4e2.js";import{C as te}from"./constants-97c4dd5f.js";import{r as se}from"./formRules-eb36c657.js";import{u as oe}from"./useVxeCrudSchemas-092b8963.js";import{a as ie,d as ne,e as de,b as re,c as ue,u as ce,f as me,r as pe,i as fe}from"./index-5d266c5c.js";import{l as ye}from"./index-a751e4d0.js";import{l as ve}from"./index-676910fd.js";import{l as he}from"./index-2af8984f.js";import{c as we,d as ke}from"./index-f8ac632b.js";import{u as _e}from"./useXTable-309dffed.js";const{t:ge}=e(),be=a({username:[se],nickname:[se],password:[se],deptId:[se],email:[{required:!0,message:ge("profile.rules.mail"),trigger:"blur"},{type:"email",message:ge("profile.rules.truemail"),trigger:["blur","change"]}],status:[se],mobile:[se,{len:11,trigger:"blur",message:"请输入正确的手机号码"},{validator:(e,a,l)=>{const t=/^1(3[0-9]|4[01456879]|5[0-35-9]|6[2567]|7[0-8]|8[0-9]|9[0-35-9])\d{8}$/;""===a?l(new Error("请输入联系手机")):t.test(a)?l():l(new Error("请输入正确的手机号"))},trigger:"blur"}]}),xe=a({primaryKey:"id",primaryType:"id",primaryTitle:"用户编号",action:!0,actionWidth:"200px",columns:[{title:"用户账号",field:"username",isSearch:!0},{title:"用户密码",field:"password",isDetail:!1,isTable:!1,form:{component:"InputPassword"}},{title:"用户"+ge("profile.user.sex"),field:"sex",dictType:l.SYSTEM_USER_SEX,dictClass:"number",table:{show:!1}},{title:"用户昵称",field:"nickname"},{title:"用户邮箱",field:"email"},{title:"手机号码",field:"mobile",isSearch:!0},{title:"部门",field:"deptId",isTable:!1},{title:"岗位",field:"postIds",isTable:!1},{title:ge("common.status"),field:"status",dictType:l.COMMON_STATUS,dictClass:"number",isSearch:!0,table:{slots:{default:"status_default"}}},{title:"最后登录时间",field:"loginDate",formatter:"formatDate",isForm:!1},{title:"最后登录IP",field:"loginIp",isTable:!1,isForm:!1},{title:ge("form.remark"),field:"remark",isTable:!1},{title:ge("common.createTime"),field:"createTime",formatter:"formatDate",isTable:!1,isForm:!1,search:{show:!0,itemRender:{name:"XDataTimePicker"}}}]}),{allSchemas:Ie}=oe(xe),Ve=e=>(Y("data-v-c23973b1"),e=e(),G(),e),Ce={class:"flex"},Se={class:"card-header"},Ue=Ve((()=>m("span",null,"部门列表",-1))),Ee={class:"card-header"},Te=Ve((()=>m("div",{class:"el-upload__text"},[x("将文件拖到此处，或"),m("em",null,"点击上传")],-1))),je=Ve((()=>m("div",{class:"el-upload__tip"},"请上传 .xls , .xlsx 标准格式文件",-1))),Ae=t({name:"User"}),Le=H(t({...Ae,setup(l){const{t:t}=e(),Y=s(),G=a({deptId:null}),H=o("用户列表"),[se,{reload:oe,deleteData:ge,exportList:xe}]=_e({allSchemas:Ie,params:G,getListApi:ie,deleteApi:ne,exportListApi:de}),Ve=o(""),Ae=o([]),Le=o(),Be=(e,a)=>!e||a.name.includes(e),De=async e=>{G.deptId=e.id,await oe()},{push:Me}=i();n(Ve,(e=>{Le.value.filter(e)}));const Ne=o(!1),Re=o(""),Fe=o(!1),Pe=o("edit"),ze=o(),Oe=o([]),Xe=(e,a)=>{var l,t="";if(e&&a){for(const s of e)if(s.id==a){if(t=s.name)return t}else if((null==(l=s.children)?void 0:l.length)&&(t=Xe(s.children,a)))return t;return t}return a},qe=async e=>{Pe.value=t("action."+e),Re.value=e,Fe.value=!0},Je=o(),Ke=o(!1),Qe=o(),We=a({id:0,username:"",nickname:"",roleIds:[]}),Ye=o(!1),Ge=o(!1),He=o("用户导入"),$e=o(0);const Ze=o(),ea=e=>{const a="application/vnd.ms-excel"===e.type||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===e.type,l=e.size/1024/1024<5;return a||Y.error("上传文件只能是 xls / xlsx 格式!"),l||Y.error("上传文件大小不能超过 5MB!"),a&&l},aa=o(),la=async e=>{if(0!==e.code)return void Y.error(e.msg);Ye.value=!1,Ge.value=!1;const a=e.data;let l="上传成功数量："+a.createUsernames.length+";";for(let t of a.createUsernames)l+="< "+t+" >";l+="更新成功数量："+a.updateUsernames.length+";";for(const t of a.updateUsernames)l+="< "+t+" >";l+="更新失败数量："+Object.keys(a.failureUsernames).length+";";for(const t in a.failureUsernames)l+="< "+t+": "+a.failureUsernames[t]+" >";Y.alert(l),await oe()},ta=()=>{Y.error("最多只能上传一个文件！")},sa=()=>{Y.error("导入数据失败，请您重新上传！")};return d((async()=>{await(async()=>{const e=await he();Oe.value.push(...e)})(),await(async()=>{const e=await ye();Ae.value.push(...le(e))})()})),(e,a)=>{const l=U,s=E,i=T,n=j,d=A,G=L,le=B,ie=$,ne=Z,de=ee,ye=D,he=M,_e=N,oa=R,ia=F,na=P,da=z,ra=O,ua=X,ca=q,ma=J,pa=K,fa=Q,ya=W,va=r("hasPermi");return u(),c(g,null,[m("div",Ce,[p(d,{class:"w-1/5 user",gutter:12,shadow:"always"},{header:f((()=>[m("div",Se,[Ue,p(l,{title:"修改部门",onClick:a[0]||(a[0]=e=>{Me("/system/dept")})})])])),default:f((()=>[p(s,{modelValue:y(Ve),"onUpdate:modelValue":a[1]||(a[1]=e=>v(Ve)?Ve.value=e:null),placeholder:"搜索部门"},null,8,["modelValue"]),p(n,{height:"650"},{default:f((()=>[p(i,{ref_key:"treeRef",ref:Le,"node-key":"id","default-expand-all":"",data:y(Ae),props:y(ae),"highlight-current":!0,"filter-node-method":Be,"expand-on-click-node":!1,onNodeClick:De},null,8,["data","props"])])),_:1})])),_:1}),p(d,{class:"w-4/5 user",style:{"margin-left":"10px"},gutter:12,shadow:"hover"},{header:f((()=>[m("div",Ee,[m("span",null,h(y(H)),1)])])),default:f((()=>[p(ye,{onRegister:y(se)},{toolbar_buttons:f((()=>[w(p(G,{type:"primary",preIcon:"ep:zoom-in",title:y(t)("action.add"),onClick:a[2]||(a[2]=e=>(async()=>{var e,a;qe("create"),await I(),"username"!==Ie.formSchema[0].field&&(null==(e=y(ze))||e.addSchema({field:"username",label:"用户账号",component:"Input"},0),null==(a=y(ze))||a.addSchema({field:"password",label:"用户密码",component:"InputPassword"},1))})())},null,8,["title"]),[[va,["system:user:create"]]]),w(p(G,{type:"warning",preIcon:"ep:upload",title:y(t)("action.import"),onClick:a[3]||(a[3]=e=>Ye.value=!0)},null,8,["title"]),[[va,["system:user:import"]]]),w(p(G,{type:"warning",preIcon:"ep:download",title:y(t)("action.export"),onClick:a[4]||(a[4]=e=>y(xe)("用户数据.xls"))},null,8,["title"]),[[va,["system:user:export"]]])])),status_default:f((({row:e})=>[p(le,{modelValue:e.status,"onUpdate:modelValue":a=>e.status=a,"active-value":0,"inactive-value":1,onChange:a=>(async e=>{const a=e.status===te.ENABLE?"启用":"停用";Y.confirm('确认要"'+a+'""'+e.username+'"用户吗?',t("common.reminder")).then((async()=>{e.status=e.status===te.ENABLE?te.ENABLE:te.DISABLE,await me(e.id,e.status),Y.success(a+"成功"),await oe()})).catch((()=>{e.status=e.status===te.ENABLE?te.DISABLE:te.ENABLE}))})(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])])),actionbtns_default:f((({row:e})=>[w(p(l,{preIcon:"ep:edit",title:y(t)("action.edit"),onClick:a=>(async e=>{var a,l,t;qe("update"),await I(),null==(a=y(ze))||a.delSchema("username"),null==(l=y(ze))||l.delSchema("password");const s=await re(e);null==(t=y(ze))||t.setValues(s)})(e.id)},null,8,["title","onClick"]),[[va,["system:user:update"]]]),w(p(l,{preIcon:"ep:view",title:y(t)("action.detail"),onClick:a=>(async e=>{const a=await re(e);Je.value=a,await qe("detail")})(e.id)},null,8,["title","onClick"]),[[va,["system:user:update"]]]),w((u(),k(de,{class:"p-0.5"},{dropdown:f((()=>[p(ne,null,{default:f((()=>[p(ie,null,{default:f((()=>[w(p(l,{preIcon:"ep:key",title:"重置密码",onClick:a=>(e=>{Y.prompt('请输入"'+e.username+'"的新密码',t("common.reminder")).then((({value:a})=>{pe(e.id,a).then((()=>{Y.success("修改成功，新密码是："+a)}))}))})(e)},null,8,["onClick"]),[[va,["system:user:update-password"]]])])),_:2},1024),p(ie,null,{default:f((()=>[w(p(l,{preIcon:"ep:key",title:"分配角色",onClick:a=>(async e=>{We.id=e.id,We.username=e.username,We.nickname=e.nickname;const a=await we(e.id);We.roleIds=a;const l=await ve();Qe.value=l,console.log(l),Ke.value=!0})(e)},null,8,["onClick"]),[[va,["system:permission:assign-user-role"]]])])),_:2},1024),p(ie,null,{default:f((()=>[w(p(l,{preIcon:"ep:delete",title:y(t)("action.del"),onClick:a=>y(ge)(e.id)},null,8,["title","onClick"]),[[va,["system:user:delete"]]])])),_:2},1024)])),_:2},1024)])),default:f((()=>[p(l,{title:y(t)("action.more"),postIcon:"ep:arrow-down"},null,8,["title"])])),_:2},1024)),[[va,["system:user:update-password","system:permission:assign-user-role","system:user:delete"]]])])),_:1},8,["onRegister"])])),_:1})]),p(ra,{modelValue:y(Fe),"onUpdate:modelValue":a[7]||(a[7]=e=>v(Fe)?Fe.value=e:null),title:y(Pe),"destroy-on-close":""},{footer:f((()=>[["create","update"].includes(y(Re))?(u(),k(G,{key:0,type:"primary",title:y(t)("action.save"),loading:y(Ne),onClick:a[5]||(a[5]=e=>(async()=>{var e;const a=null==(e=y(ze))?void 0:e.getElFormRef();a&&a.validate((async e=>{var a;if(e)try{const e=null==(a=y(ze))?void 0:a.formModel;"create"===Re.value?(Ne.value=!0,await ue(e),Y.success(t("common.createSuccess"))):(Ne.value=!0,await ce(e),Y.success(t("common.updateSuccess"))),Fe.value=!1}finally{await oe(),Ne.value=!1}}))})())},null,8,["title","loading"])):_("",!0),p(G,{loading:y(Ne),title:y(t)("dialog.close"),onClick:a[6]||(a[6]=e=>Fe.value=!1)},null,8,["loading","title"])])),default:f((()=>[["create","update"].includes(y(Re))?(u(),k(ia,{key:0,rules:y(be),schema:y(Ie).formSchema,ref_key:"formRef",ref:ze},{deptId:f((e=>[p(he,{"node-key":"id",modelValue:e.deptId,"onUpdate:modelValue":a=>e.deptId=a,props:y(ae),data:y(Ae),"check-strictly":""},null,8,["modelValue","onUpdate:modelValue","props","data"])])),postIds:f((e=>[p(oa,{modelValue:e.postIds,"onUpdate:modelValue":a=>e.postIds=a,multiple:"",placeholder:y(t)("common.selectText")},{default:f((()=>[(u(!0),c(g,null,b(y(Oe),(e=>(u(),k(_e,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])])),_:1},8,["rules","schema"])):_("",!0),"detail"===y(Re)?(u(),k(da,{key:1,schema:y(Ie).detailSchema,data:y(Je)},{deptId:f((({row:e})=>[p(na,null,{default:f((()=>{return[x(h((a=e.deptId,Xe(Ae.value,a))),1)];var a})),_:2},1024)])),postIds:f((({row:e})=>[""!==e.postIds?(u(!0),c(g,{key:0},b(e.postIds,((e,a)=>(u(),k(na,{key:a,index:""},{default:f((()=>[(u(!0),c(g,null,b(y(Oe),(a=>(u(),c(g,null,[x(h(e===a.id?a.name:""),1)],64)))),256))])),_:2},1024)))),128)):(u(),c(g,{key:1},[],64))])),_:1},8,["schema","data"])):_("",!0)])),_:1},8,["modelValue","title"]),p(ra,{modelValue:y(Ke),"onUpdate:modelValue":a[11]||(a[11]=e=>v(Ke)?Ke.value=e:null),title:"分配角色"},{footer:f((()=>[p(G,{type:"primary",title:y(t)("action.save"),loading:y(Ne),onClick:a[9]||(a[9]=e=>(async()=>{const e=o({userId:We.id,roleIds:We.roleIds});await ke(e.value),Y.success(t("common.updateSuccess")),Ke.value=!1})())},null,8,["title","loading"]),p(G,{title:y(t)("dialog.close"),onClick:a[10]||(a[10]=e=>Ke.value=!1)},null,8,["title"])])),default:f((()=>[x(h(y(We))+" ",1),p(ma,{model:y(We),"label-width":"140px",inline:!0},{default:f((()=>[p(ua,{label:"用户名称"},{default:f((()=>[p(na,null,{default:f((()=>[x(h(y(We).username),1)])),_:1})])),_:1}),p(ua,{label:"用户昵称"},{default:f((()=>[p(na,null,{default:f((()=>[x(h(y(We).nickname),1)])),_:1})])),_:1}),p(ua,{label:"角色"},{default:f((()=>[p(ca,{modelValue:y(We).roleIds,"onUpdate:modelValue":a[8]||(a[8]=e=>y(We).roleIds=e),titles:["角色列表","已选择"],props:{key:"id",label:"name"},data:y(Qe)},null,8,["modelValue","data"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"]),p(ra,{modelValue:y(Ye),"onUpdate:modelValue":a[16]||(a[16]=e=>v(Ye)?Ye.value=e:null),title:y(He)},{footer:f((()=>[p(G,{type:"warning",preIcon:"ep:upload-filled",title:y(t)("action.save"),onClick:a[14]||(a[14]=e=>(Ze.value={Authorization:"Bearer "+C(),"tenant-id":S()},Ge.value=!0,void aa.value.submit()))},null,8,["title"]),p(G,{title:y(t)("dialog.close"),onClick:a[15]||(a[15]=e=>Ye.value=!1)},null,8,["title"])])),default:f((()=>[p(ma,{class:"drawer-multiColumn-form","label-width":"150px"},{default:f((()=>[p(ua,{label:"模板下载 :"},{default:f((()=>[p(G,{type:"primary",prefix:"ep:download",title:"点击下载",onClick:a[12]||(a[12]=e=>(async()=>{const e=await fe();V.excel(e,"用户导入模版.xls")})())})])),_:1}),p(ua,{label:"文件上传 :"},{default:f((()=>[p(fa,{ref_key:"uploadRef",ref:aa,action:y("https://mesv2-api.cloudmes.io/admin-api/system/user/import")+"?updateSupport="+y($e),headers:y(Ze),drag:!0,limit:1,multiple:!0,"show-file-list":!0,disabled:y(Ge),"before-upload":ea,"on-exceed":ta,"on-success":la,"on-error":sa,"auto-upload":!1,accept:"application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"},{tip:f((()=>[je])),default:f((()=>[p(pa,{icon:"ep:upload-filled"}),Te])),_:1},8,["action","headers","disabled"])])),_:1}),p(ua,{label:"是否更新已经存在的用户数据:"},{default:f((()=>[p(ya,{modelValue:y($e),"onUpdate:modelValue":a[13]||(a[13]=e=>v($e)?$e.value=e:null)},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue","title"])],64)}}}),[["__scopeId","data-v-c23973b1"],["__file","/Users/alex/Downloads/万界星空/产品研发/MES框架/dev/xiejinrun/new_open_mes_front/src/views/system/user/index.vue"]]);export{Le as default};
